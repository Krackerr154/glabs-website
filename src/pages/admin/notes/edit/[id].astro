---
// Admin - Edit note
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { requireAuth } from '../../../../lib/auth';
import { prisma } from '../../../../lib/db';

// Protect this route
try {
  requireAuth(Astro.cookies);
} catch {
  return Astro.redirect('/admin/login');
}

const { id } = Astro.params;
let error = '';

// Get the note
const note = await prisma.note.findUnique({
  where: { id },
});

if (!note) {
  return Astro.redirect('/admin/notes');
}

// Parse tags
const tags = JSON.parse(note.tags || '[]').join(', ');

// Handle form submission
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const title = formData.get('title')?.toString() || '';
    const slug = formData.get('slug')?.toString() || '';
    const description = formData.get('description')?.toString() || '';
    const content = formData.get('content')?.toString() || '';
    const tagsInput = formData.get('tags')?.toString() || '';
    const published = formData.get('published') === 'on';
    
    // Parse tags
    const tagArray = tagsInput.split(',').map(t => t.trim()).filter(t => t);
    
    // Update note
    await prisma.note.update({
      where: { id },
      data: {
        title,
        slug,
        description,
        content,
        tags: JSON.stringify(tagArray),
        published,
      },
    });
    
    return Astro.redirect('/admin/notes');
  } catch (e: any) {
    error = e.message || 'Failed to update note';
  }
}

export const prerender = false;
---

<BaseLayout title="Edit Note" description="Edit note">
  <div class="min-h-screen bg-slate-50">
    <!-- Admin Header -->
    <header class="bg-white border-b border-slate-200">
      <div class="container mx-auto px-4 py-4">
        <a href="/admin/notes" class="text-sm text-cyan-600 hover:text-cyan-700 mb-2 inline-block">
          ‚Üê Back to Notes
        </a>
        <h1 class="text-2xl font-bold text-slate-800">Edit Note</h1>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 max-w-4xl">
      {error && (
        <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-6">
          {error}
        </div>
      )}
      
      <form method="POST" class="card p-8 space-y-6">
        <div>
          <label for="title" class="block text-sm font-medium text-slate-700 mb-2">
            Title *
          </label>
          <input
            type="text"
            id="title"
            name="title"
            value={note.title}
            required
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none"
          />
        </div>
        
        <div>
          <label for="slug" class="block text-sm font-medium text-slate-700 mb-2">
            Slug *
          </label>
          <input
            type="text"
            id="slug"
            name="slug"
            value={note.slug}
            required
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none"
          />
        </div>
        
        <div>
          <label for="description" class="block text-sm font-medium text-slate-700 mb-2">
            Description
          </label>
          <textarea
            id="description"
            name="description"
            rows="3"
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none resize-none"
          >{note.description}</textarea>
        </div>
        
        <div>
          <label for="content" class="block text-sm font-medium text-slate-700 mb-2">
            Content * (Markdown)
          </label>
          <textarea
            id="content"
            name="content"
            rows="15"
            required
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none font-mono text-sm"
          >{note.content}</textarea>
        </div>
        
        <div>
          <label for="tags" class="block text-sm font-medium text-slate-700 mb-2">
            Tags
          </label>
          <input
            type="text"
            id="tags"
            name="tags"
            value={tags}
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none"
          />
          <p class="text-xs text-slate-500 mt-1">Separate tags with commas</p>
        </div>
        
        <div class="flex items-center">
          <input
            type="checkbox"
            id="published"
            name="published"
            checked={note.published}
            class="w-4 h-4 text-cyan-600 border-slate-300 rounded focus:ring-cyan-500"
          />
          <label for="published" class="ml-2 text-sm font-medium text-slate-700">
            Published
          </label>
        </div>
        
        <div class="flex gap-4">
          <button type="submit" class="btn-primary flex-1">
            Update Note
          </button>
          <a href="/admin/notes" class="btn-secondary flex-1 text-center">
            Cancel
          </a>
        </div>
      </form>
    </main>
  </div>
</BaseLayout>
